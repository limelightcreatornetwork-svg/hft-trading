generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "postgresql"
}

// Trading Intent - what the strategy wants to do
model Intent {
  id          String   @id @default(cuid())
  symbol      String
  side        String   // BUY, SELL
  quantity    Int
  orderType   String   // MARKET, LIMIT
  limitPrice  Float?
  strategy    String
  status      String   @default("PENDING") // PENDING, APPROVED, REJECTED, EXECUTED
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  orders      Order[]
  riskChecks  RiskCheck[]
}

// Risk Check Results
model RiskCheck {
  id        String   @id @default(cuid())
  intentId  String
  intent    Intent   @relation(fields: [intentId], references: [id])
  checkName String
  passed    Boolean
  details   String?
  createdAt DateTime @default(now())
}

// Orders submitted to broker
model Order {
  id            String   @id @default(cuid())
  intentId      String
  intent        Intent   @relation(fields: [intentId], references: [id])
  brokerOrderId String?  @unique
  symbol        String
  side          String
  quantity      Int
  orderType     String
  limitPrice    Float?
  status        String   @default("PENDING") // PENDING, SUBMITTED, FILLED, PARTIALLY_FILLED, CANCELLED, REJECTED
  filledQty     Int      @default(0)
  avgFillPrice  Float?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  fills         Fill[]
}

// Individual fills
model Fill {
  id        String   @id @default(cuid())
  orderId   String
  order     Order    @relation(fields: [orderId], references: [id])
  quantity  Int
  price     Float
  timestamp DateTime
  createdAt DateTime @default(now())
}

// Current positions
model Position {
  id           String   @id @default(cuid())
  symbol       String   @unique
  quantity     Int
  avgCost      Float
  marketValue  Float?
  unrealizedPL Float?
  updatedAt    DateTime @updatedAt
}

// Risk configuration
model RiskConfig {
  id                String   @id @default(cuid())
  maxPositionSize   Int      @default(1000)
  maxDailyLoss      Float    @default(1000)
  maxOrderSize      Int      @default(100)
  allowedSymbols    String[] @default([])
  tradingEnabled    Boolean  @default(false)
  // Options-specific limits
  maxOptionsContracts    Int     @default(10)
  maxPremiumAtRisk       Float   @default(500)
  maxDeltaExposure       Float   @default(100)
  minDaysToExpiration    Int     @default(1)
  updatedAt         DateTime @updatedAt
}

// ============================================
// OPTIONS TRADING MODELS
// ============================================

// Options Contract Definition
model OptionsContract {
  id              String   @id @default(cuid())
  symbol          String   @unique  // e.g., "AAPL260207C00190000"
  underlying      String             // e.g., "AAPL"
  contractType    String             // CALL, PUT
  strike          Float
  expiration      DateTime
  multiplier      Int      @default(100)
  createdAt       DateTime @default(now())
  positions       OptionsPosition[]
  orders          OptionsOrder[]
}

// Options Intent - what the strategy wants to do with options
model OptionsIntent {
  id              String   @id @default(cuid())
  contractSymbol  String             // Options contract symbol
  underlying      String             // Underlying symbol
  side            String             // BUY_TO_OPEN, BUY_TO_CLOSE, SELL_TO_OPEN, SELL_TO_CLOSE
  quantity        Int
  orderType       String             // MARKET, LIMIT
  limitPrice      Float?
  strategy        String
  maxPremiumRisk  Float?             // Max premium willing to pay/risk
  status          String   @default("PENDING")
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  orders          OptionsOrder[]
  riskChecks      OptionsRiskCheck[]
}

// Options Risk Check Results
model OptionsRiskCheck {
  id        String         @id @default(cuid())
  intentId  String
  intent    OptionsIntent  @relation(fields: [intentId], references: [id])
  checkName String
  passed    Boolean
  details   String?
  createdAt DateTime       @default(now())
}

// Options Orders
model OptionsOrder {
  id              String          @id @default(cuid())
  intentId        String
  intent          OptionsIntent   @relation(fields: [intentId], references: [id])
  contractId      String
  contract        OptionsContract @relation(fields: [contractId], references: [id])
  brokerOrderId   String?         @unique
  side            String
  quantity        Int
  orderType       String
  limitPrice      Float?
  status          String          @default("PENDING")
  filledQty       Int             @default(0)
  avgFillPrice    Float?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  fills           OptionsFill[]
}

// Options Fills
model OptionsFill {
  id        String       @id @default(cuid())
  orderId   String
  order     OptionsOrder @relation(fields: [orderId], references: [id])
  quantity  Int
  price     Float
  timestamp DateTime
  createdAt DateTime     @default(now())
}

// Options Positions with Greeks
model OptionsPosition {
  id              String          @id @default(cuid())
  contractId      String
  contract        OptionsContract @relation(fields: [contractId], references: [id])
  quantity        Int             // Positive = long, Negative = short
  avgCost         Float
  marketValue     Float?
  unrealizedPL    Float?
  // Greeks
  delta           Float?
  gamma           Float?
  theta           Float?
  vega            Float?
  impliedVol      Float?
  updatedAt       DateTime        @updatedAt
  greeksHistory   OptionsGreeksSnapshot[]

  @@unique([contractId])
}

// Greeks History for tracking over time
model OptionsGreeksSnapshot {
  id          String          @id @default(cuid())
  positionId  String
  position    OptionsPosition @relation(fields: [positionId], references: [id])
  delta       Float
  gamma       Float
  theta       Float
  vega        Float
  impliedVol  Float
  underlyingPrice Float
  timestamp   DateTime        @default(now())
}

// Portfolio-level Greeks Summary
model PortfolioGreeks {
  id          String   @id @default(cuid())
  netDelta    Float
  netGamma    Float
  netTheta    Float
  netVega     Float
  timestamp   DateTime @default(now())
}

// ============================================
// CONFIDENCE-BASED TRADING MODELS
// ============================================

// Managed Position with confidence scoring and TP/SL
model ManagedPosition {
  id            String   @id @default(cuid())
  symbol        String
  side          String   // buy/sell
  quantity      Float
  entryPrice    Float
  confidence    Int      // 1-10
  takeProfitPct Float    // e.g., 2.0 for 2%
  stopLossPct   Float    // e.g., 1.0 for 1%
  timeStopHours Float    // e.g., 4.0 for 4 hours
  trailingStopPct Float? // Optional trailing stop percentage
  highWaterMark Float?   // Highest price reached (for trailing stop)
  enteredAt     DateTime @default(now())
  closedAt      DateTime?
  closePrice    Float?
  closeReason   String?  // TP_HIT, SL_HIT, TIME_STOP, MANUAL, TRAILING_STOP
  status        String   @default("active") // active/closed/alerted
  pnl           Float?
  pnlPct        Float?
  alerts        Alert[]
  
  // Confidence scoring breakdown (stored for analysis)
  technicalScore    Int?
  riskRewardScore   Int?
  marketCondScore   Int?
  timeOfDayScore    Int?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([symbol])
  @@index([status])
  @@index([enteredAt])
}

// Alert for managed positions
model Alert {
  id          String   @id @default(cuid())
  positionId  String
  type        String   // TP_HIT, SL_HIT, TIME_STOP, REVIEW, TRAILING_TRIGGERED
  message     String
  triggered   Boolean  @default(false)
  triggeredAt DateTime?
  dismissed   Boolean  @default(false)
  dismissedAt DateTime?
  position    ManagedPosition @relation(fields: [positionId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())

  @@index([positionId])
  @@index([triggered])
  @@index([type])
}

// ============================================
// RESEARCH, STRATEGY & ANALYSIS MODELS
// ============================================

// Trading Strategy
model Strategy {
  id              String   @id @default(cuid())
  name            String
  description     String?
  type            String   @default("manual") // manual, momentum, meanReversion, breakout
  entryConditions Json     // { indicators: [...], thresholds: [...] }
  exitConditions  Json     // { stopLoss: %, takeProfit: %, trailingStop: % }
  positionSizing  Json     // { method: "fixed"|"kelly"|"percent", value: ... }
  riskParams      Json     // { maxLoss: %, maxPositions: n }
  symbols         String[] @default([])
  isActive        Boolean  @default(false)
  backtestResults Json?    // { returns: %, sharpe: n, winRate: % }
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// Watchlist
model Watchlist {
  id        String   @id @default(cuid())
  name      String   @default("Default")
  symbols   String[]
  notes     Json?    // { "AAPL": "watching for breakout", ... }
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Analysis Snapshot (daily portfolio metrics)
model AnalysisSnapshot {
  id              String   @id @default(cuid())
  date            DateTime @unique
  totalValue      Float
  dailyPnl        Float
  totalPnl        Float
  winRate         Float?
  sharpeRatio     Float?
  maxDrawdown     Float?
  tradesCount     Int      @default(0)
  winningTrades   Int      @default(0)
  losingTrades    Int      @default(0)
  avgWin          Float?
  avgLoss         Float?
  positionsJson   Json?    // Snapshot of positions
  createdAt       DateTime @default(now())
}

// Market News Cache
model NewsItem {
  id          String   @id @default(cuid())
  headline    String
  summary     String?
  url         String   @unique
  source      String
  symbols     String[] @default([])
  sentiment   Float?   // -1 to 1
  publishedAt DateTime
  fetchedAt   DateTime @default(now())

  @@index([publishedAt])
  @@index([symbols])
}

// Technical Indicator Cache
model TechnicalData {
  id        String   @id @default(cuid())
  symbol    String
  timeframe String   @default("1D")
  rsi       Float?
  macd      Float?
  macdSignal Float?
  sma20     Float?
  sma50     Float?
  sma200    Float?
  ema12     Float?
  ema26     Float?
  atr       Float?
  volume    Float?
  timestamp DateTime
  updatedAt DateTime @updatedAt

  @@unique([symbol, timeframe, timestamp])
  @@index([symbol])
}

// ============================================
// AUDIT LOGGING
// ============================================

// Audit Log for security and compliance tracking
model AuditLog {
  id          String   @id @default(cuid())
  action      String   // ORDER_SUBMITTED, KILL_SWITCH_ACTIVATED, etc.
  userId      String?  // Optional user identifier
  clientId    String?  // API client identifier
  symbol      String?  // Related trading symbol
  orderId     String?  // Related order ID
  intentId    String?  // Related intent ID
  positionId  String?  // Related position ID
  details     String?  // JSON string with additional details
  ipAddress   String?  // Client IP address
  userAgent   String?  // Client user agent
  createdAt   DateTime @default(now())

  @@index([action])
  @@index([userId])
  @@index([symbol])
  @@index([createdAt])
}
